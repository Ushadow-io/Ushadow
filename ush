#!/usr/bin/env python3
"""
ush - ushadow Command Line Tool

Modern CLI built on auto-generated API client from OpenAPI spec.

Examples:
    ush health                       # Check backend health
    ush services list                # List all services
    ush services start chronicle     # Start a service
    ush services stop chronicle      # Stop a service
    ush services restart chronicle   # Restart a service
    ush services status chronicle    # Get service status
    ush services logs chronicle      # View service logs
    ush services env-export chronicle  # Export env vars
    ush api GET /api/services/       # Raw API call
"""

import json
import sys
from pathlib import Path
from typing import Optional

import typer
from rich.console import Console
from rich.table import Table
from typing_extensions import Annotated

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

from ushadow.client.auth import UshadowClient

# Initialize Typer app
app = typer.Typer(
    name="ush",
    help="ushadow command-line interface",
    add_completion=False,
    no_args_is_help=True,  # Show help when no args provided
)

# Service management commands
services_app = typer.Typer(
    help="Service management commands",
    no_args_is_help=True,  # Show help when just "ush services" is run
)
app.add_typer(services_app, name="services")

# Global options
verbose_option = Annotated[
    bool,
    typer.Option("--verbose", "-v", help="Enable verbose output")
]

console = Console()


def get_client(verbose: bool = False) -> UshadowClient:
    """Get client from environment."""
    try:
        return UshadowClient.from_env(verbose=verbose)
    except Exception as e:
        console.print(f"[red]‚ùå Failed to initialize client: {e}[/red]")
        raise typer.Exit(code=1)


def format_status(status: str, health: Optional[str] = None) -> str:
    """Format status with icon."""
    if status == "running":
        if health == "healthy":
            return "üü¢ running"
        elif health == "unhealthy":
            return "üü° running (unhealthy)"
        return "üîµ running"
    elif status in ("stopped", "not_found", "exited"):
        return "üî¥ " + status
    elif status == "created":
        return "‚ö™ created"
    return "‚ö™ " + status


@app.command()
def health(verbose: verbose_option = False):
    """Check ushadow backend health."""
    try:
        client = get_client(verbose=verbose)
        result = client.health()
        console.print("[green]‚úÖ ushadow backend healthy[/green]")
        if verbose:
            console.print(json.dumps(result, indent=2))
    except Exception as e:
        console.print(f"[red]‚ùå Backend unreachable: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("list")
def services_list(verbose: verbose_option = False):
    """List all services."""
    try:
        client = get_client(verbose=verbose)
        services = client.list_services()

        if not services:
            console.print("[yellow]No services found[/yellow]")
            return

        table = Table(title="Services", show_header=True, header_style="bold magenta")
        table.add_column("Name", style="cyan", width=25)
        table.add_column("Status", width=20)
        table.add_column("Installed", width=10)
        table.add_column("Description", overflow="fold")

        for svc in services:
            status = format_status(svc.get("status", "unknown"), svc.get("health"))
            installed = "‚úÖ" if svc.get("installed") else "‚ùå"
            desc = (svc.get("description") or "")[:40]

            table.add_row(
                svc.get("service_name", "unknown"),
                status,
                installed,
                desc,
            )

        console.print(table)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("status")
def services_status(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Get status of a specific service."""
    try:
        client = get_client(verbose=verbose)
        service = client.get_service(service_name)

        status = format_status(service.get("status", "unknown"), service.get("health"))
        console.print(f"{status} [bold]{service_name}[/bold]")

        if service.get("ports"):
            ports = service["ports"]
            if isinstance(ports, list) and ports:
                port_strs = [f"{p.get('host', '?')}:{p.get('container', '?')}" for p in ports]
                console.print(f"   Ports: {', '.join(port_strs)}")

        if verbose:
            console.print(f"   Image: {service.get('image', 'unknown')}")
            if service.get("description"):
                console.print(f"   Description: {service['description']}")

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("start")
def services_start(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Start a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üîÑ Starting [bold]{service_name}[/bold]...")
        result = client.start_service(service_name)

        if result.get("success"):
            console.print(f"[green]‚úÖ {service_name} started successfully[/green]")
            if result.get("message"):
                console.print(f"   {result['message']}")
        else:
            console.print(f"[red]‚ùå {result.get('message', 'Operation failed')}[/red]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("stop")
def services_stop(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Stop a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üîÑ Stopping [bold]{service_name}[/bold]...")
        result = client.stop_service(service_name)

        if result.get("success"):
            console.print(f"[green]‚úÖ {service_name} stopped successfully[/green]")
        else:
            console.print(f"[red]‚ùå {result.get('message', 'Operation failed')}[/red]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("restart")
def services_restart(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Restart a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üîÑ Restarting [bold]{service_name}[/bold]...")
        result = client.restart_service(service_name)

        if result.get("success"):
            console.print(f"[green]‚úÖ {service_name} restarted successfully[/green]")
            if result.get("message"):
                console.print(f"   {result['message']}")
        else:
            console.print(f"[red]‚ùå {result.get('message', 'Operation failed')}[/red]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("logs")
def services_logs(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    lines: Annotated[int, typer.Option("--lines", "-n", help="Number of lines")] = 100,
    verbose: verbose_option = False,
):
    """View service logs."""
    try:
        client = get_client(verbose=verbose)
        result = client.get_service_logs(service_name, lines=lines)

        logs = result.get("logs", "")
        if logs:
            console.print(logs)
        else:
            console.print(f"[yellow]No logs available for {service_name}[/yellow]")

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("env-export")
def services_env_export(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    output: Annotated[Optional[str], typer.Option("--output", "-o", help="Output file")] = None,
    verbose: verbose_option = False,
):
    """Export environment variables for a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üì¶ Exporting env vars for [bold]{service_name}[/bold]...")
        result = client.export_service_env(service_name)

        env_vars = result.get("env_vars", {})
        if not env_vars:
            console.print(f"[yellow]No environment variables to export[/yellow]")
            return

        # Determine output file
        output_file = output or f".env.{service_name}"

        # Format and write
        env_lines = [f"{k}={v}" for k, v in sorted(env_vars.items())]
        with open(output_file, "w") as f:
            f.write(f"# Environment variables for {service_name}\n")
            f.write(f"# Generated by ush\n\n")
            f.write("\n".join(env_lines))
            f.write("\n")

        console.print(f"[green]‚úÖ Exported {len(env_vars)} env vars to {output_file}[/green]")

        if not result.get("ready"):
            missing = result.get("missing", [])
            if missing:
                console.print(f"[yellow]‚ö†Ô∏è  Missing vars: {', '.join(missing)}[/yellow]")

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@app.command()
def api(
    method: Annotated[str, typer.Argument(help="HTTP method (GET, POST, etc.)")],
    endpoint: Annotated[str, typer.Argument(help="API endpoint path")],
    data: Annotated[Optional[str], typer.Option("--data", "-d", help="JSON request body")] = None,
    no_auth: Annotated[bool, typer.Option("--no-auth", help="Skip authentication")] = False,
    verbose: verbose_option = False,
):
    """Make a raw API request."""
    try:
        client = get_client(verbose=verbose)

        # Parse data if provided
        body = json.loads(data) if data else None

        if verbose:
            console.print(f"[dim]üîó {method.upper()} {endpoint}[/dim]")

        result = client.api(method, endpoint, data=body, auth=not no_auth)

        # Pretty print response
        console.print(json.dumps(result, indent=2))

    except json.JSONDecodeError as e:
        console.print(f"[red]‚ùå Invalid JSON: {e}[/red]")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


if __name__ == "__main__":
    app()
