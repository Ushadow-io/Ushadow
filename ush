#!/usr/bin/env python3
"""
ush - ushadow Command Line Tool

Modern CLI built on auto-generated API client from OpenAPI spec.
Always in sync with the backend API.

Examples:
    ush health                      # Check backend health
    ush services list               # List all services
    ush services start chronicle    # Start a service
    ush services stop chronicle     # Stop a service
    ush services status chronicle   # Get service status
    ush api GET /api/services/      # Raw API call
"""

import sys
from pathlib import Path
from typing import Optional

import typer
from rich.console import Console
from rich.table import Table
from typing_extensions import Annotated

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

from ushadow.client.auth import UshadowClient

# Initialize Typer app
app = typer.Typer(
    name="ush",
    help="ushadow command-line interface",
    add_completion=False,
)

# Service management commands
services_app = typer.Typer(help="Service management")
app.add_typer(services_app, name="services")

# Global options
verbose_option = Annotated[
    bool,
    typer.Option("--verbose", "-v", help="Enable verbose output")
]

console = Console()


def get_client(verbose: bool = False) -> UshadowClient:
    """Get authenticated client."""
    try:
        return UshadowClient.from_env(verbose=verbose)
    except ValueError as e:
        console.print(f"[red]‚ùå {e}[/red]")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[red]‚ùå Failed to initialize client: {e}[/red]")
        raise typer.Exit(code=1)


def get_unauthenticated_client() -> UshadowClient:
    """Get client for endpoints that don't require auth."""
    return UshadowClient.from_env()


@app.command()
def health(verbose: verbose_option = False):
    """Check ushadow backend health."""
    try:
        client = get_unauthenticated_client()
        result = client.health()
        console.print("[green]‚úÖ ushadow backend healthy[/green]")
        if verbose:
            console.print(result)
    except Exception as e:
        console.print(f"[red]‚ùå Backend unreachable: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("list")
def services_list(verbose: verbose_option = False):
    """List all services."""
    try:
        client = get_unauthenticated_client()
        services = client.list_services()

        if not services:
            console.print("[yellow]No services found[/yellow]")
            return

        table = Table(title="Services", show_header=True, header_style="bold magenta")
        table.add_column("Name", style="cyan", width=30)
        table.add_column("Status", width=15)
        table.add_column("Health", width=12)
        table.add_column("Description", overflow="fold")

        for svc in services:
            status_icon = {
                "running": "üü¢",
                "stopped": "üî¥",
                "exited": "üî¥",
                "not_found": "üî¥",
            }.get(svc.status or "unknown", "‚ö™")

            health_icon = {
                "healthy": "‚úÖ",
                "unhealthy": "‚ö†Ô∏è",
            }.get(svc.health or "", "")

            table.add_row(
                svc.service_name or "unknown",
                f"{status_icon} {svc.status or 'unknown'}",
                health_icon,
                (svc.description or "")[:50],
            )

        console.print(table)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("status")
def services_status(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Get status of a specific service."""
    try:
        client = get_unauthenticated_client()
        service = client.get_service(service_name)

        if not service:
            console.print(f"[red]‚ùå Service '{service_name}' not found[/red]")
            raise typer.Exit(code=1)

        status_icon = {
            "running": "üü¢",
            "stopped": "üî¥",
            "exited": "üî¥",
        }.get(service.status or "unknown", "üü°")

        console.print(f"{status_icon} [bold]{service_name}[/bold]: {service.status}")

        if service.ports:
            console.print(f"   Ports: {service.ports}")
        if verbose and service.description:
            console.print(f"   Description: {service.description}")

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("start")
def services_start(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Start a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üîÑ Starting [bold]{service_name}[/bold]...")
        result = client.start_service(service_name)

        if result.get("success"):
            console.print(f"[green]‚úÖ {service_name} started successfully[/green]")
            if result.get("message"):
                console.print(f"   {result['message']}")
        else:
            console.print(f"[red]‚ùå {result.get('message', 'Operation failed')}[/red]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@services_app.command("stop")
def services_stop(
    service_name: Annotated[str, typer.Argument(help="Service name")],
    verbose: verbose_option = False,
):
    """Stop a service."""
    try:
        client = get_client(verbose=verbose)
        console.print(f"üîÑ Stopping [bold]{service_name}[/bold]...")
        result = client.stop_service(service_name)

        if result.get("success"):
            console.print(f"[green]‚úÖ {service_name} stopped successfully[/green]")
        else:
            console.print(f"[red]‚ùå Operation failed[/red]")
            raise typer.Exit(code=1)

    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


@app.command()
def api(
    method: Annotated[str, typer.Argument(help="HTTP method (GET, POST, etc.)")],
    endpoint: Annotated[str, typer.Argument(help="API endpoint path")],
    data: Annotated[Optional[str], typer.Option("--data", "-d", help="JSON request body")] = None,
    no_auth: Annotated[bool, typer.Option("--no-auth", help="Skip authentication")] = False,
    verbose: verbose_option = False,
):
    """Make a raw API request (advanced usage)."""
    import json
    import httpx

    try:
        if not endpoint.startswith("/"):
            endpoint = "/" + endpoint

        base_url = "http://localhost:8000"
        headers = {"Content-Type": "application/json"}

        if not no_auth:
            client = get_client(verbose=verbose)
            client._ensure_authenticated()
            headers["Authorization"] = f"Bearer {client._token}"

        body = json.loads(data) if data else None

        if verbose:
            console.print(f"[dim]üîó {method.upper()} {endpoint}[/dim]")

        response = httpx.request(
            method=method.upper(),
            url=f"{base_url}{endpoint}",
            json=body,
            headers=headers,
            timeout=30.0,
        )

        if response.status_code >= 400:
            console.print(f"[red]‚ùå Error {response.status_code}[/red]")

        try:
            result = response.json()
            console.print(json.dumps(result, indent=2))
        except Exception:
            console.print(response.text)

    except json.JSONDecodeError as e:
        console.print(f"[red]‚ùå Invalid JSON: {e}[/red]")
        raise typer.Exit(code=1)
    except Exception as e:
        console.print(f"[red]‚ùå Error: {e}[/red]")
        raise typer.Exit(code=1)


if __name__ == "__main__":
    app()
