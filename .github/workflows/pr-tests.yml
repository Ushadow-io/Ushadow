name: PR Tests (No Secrets Required)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "ushadow/backend/**"
      - "ushadow/frontend/**"
      - "robot_tests/**"
      - ".github/workflows/pr-tests.yml"

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ushadow/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Run stable tests (no secrets required)
        env:
          CI: "true"
          SKIP_INTEGRATION: "false"
        run: |
          # Run all tests except those requiring secrets or TDD tests
          pytest -m "not (requires_secrets or tdd)" --cov=src --cov-report=xml --cov-report=term

      - name: Run TDD tests (allowed to fail)
        env:
          CI: "true"
          SKIP_INTEGRATION: "false"
        run: |
          # Run TDD tests separately - these are expected to fail
          pytest -m "tdd" --verbose || echo "TDD tests failed as expected"
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./ushadow/backend/coverage.xml
          flags: backend-unit
          name: backend-coverage

  frontend-build:
    name: Frontend Build Check
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ushadow/frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ushadow/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run type-check

      - name: Run linter
        run: npm run lint

      - name: Build frontend
        run: npm run build

  # Separate job for tests requiring secrets (only runs when explicitly triggered)
  backend-integration-tests:
    name: Backend Integration Tests (Secrets Required)
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch or when explicitly requested
    if: github.event_name == 'workflow_dispatch'

    defaults:
      run:
        working-directory: ushadow/backend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Start test services
        run: |
          docker compose -f ../../docker-compose.test.yml up -d mongodb redis

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until docker compose -f ../../docker-compose.test.yml ps | grep -q "healthy"; do sleep 2; done'

      - name: Run integration tests
        env:
          CI: "true"
          RUN_SECRET_TESTS: "true"
          # Add your secret env vars here when running manually
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pytest -m "requires_secrets or integration" --cov=src --cov-report=xml

      - name: Cleanup services
        if: always()
        run: |
          docker compose -f ../../docker-compose.test.yml down -v

  robot-tests:
    name: Robot Framework Tests (Secrets Required)
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch or when explicitly requested
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Robot Framework dependencies
        working-directory: robot_tests
        run: |
          pip install -r requirements.txt

      - name: Start backend services
        run: |
          docker compose up -d mongodb redis backend

      - name: Wait for backend to be healthy
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

      - name: Run Robot Framework tests
        working-directory: robot_tests
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
          TAILSCALE_API_KEY: ${{ secrets.TAILSCALE_API_KEY }}
        run: |
          robot --outputdir . tests/

      - name: Upload Robot test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-test-results
          path: |
            robot_tests/log.html
            robot_tests/report.html
            robot_tests/output.xml

      - name: Cleanup services
        if: always()
        run: |
          docker compose down -v
