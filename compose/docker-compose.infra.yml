name: infra
services:
  mongo:
    image: mongo:8.0
    container_name: mongo
    profiles:
    - infra
    command:
    - --replSet
    - rs0
    - --bind_ip_all
    ports:
    - 27017:27017
    volumes:
    - mongo_data:/data/db
    healthcheck:
      test:
      - CMD
      - mongosh
      - --quiet
      - --eval
      - try { rs.status().ok } catch(e) { 0 }
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
    - infra-network
    - ushadow-network
    restart: unless-stopped
  mongo-init:
    image: mongo:8.0
    container_name: mongo-init
    profiles:
    - infra
    depends_on:
      mongo:
        condition: service_started
    entrypoint: "mongosh --host mongo --quiet --eval \"\n  try {\n    rs.status();\n\
      \    print('Replica set already initialized');\n  } catch(e) {\n    print('Initializing\
      \ replica set...');\n    rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'mongo:27017'}]});\n\
      \    print('Replica set initialized');\n  }\n\"\n"
    networks:
    - infra-network
    restart: 'no'
  redis:
    image: redis:7-alpine
    container_name: redis
    profiles:
    - infra
    ports:
    - 6379:6379
    volumes:
    - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
    - ushadow-network
    - infra-network
    restart: unless-stopped
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    profiles:
    - memory
    - qdrant
    - infra
    ports:
    - 6333:6333
    - 6334:6334
    volumes:
    - qdrant_data:/qdrant/storage
    networks:
    - ushadow-network
    - infra-network
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://localhost:6333/health
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    profiles:
    - memory
    - metamcp
    - postgres
    ports:
    - 5432:5432
    environment:
    - POSTGRES_USER=ushadow
    - POSTGRES_PASSWORD=ushadow
    - POSTGRES_DB=ushadow
    - POSTGRES_MULTIPLE_DATABASES=metamcp,openmemory,keycloak
    volumes:
    - postgres_data:/var/lib/postgresql/data
    - ../config/postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
    - ushadow-network
    - infra-network
    restart: unless-stopped
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ushadow
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  neo4j:
    image: neo4j:latest
    container_name: neo4j
    profiles:
    - memory
    - neo4j
    ports:
    - 7474:7474
    - 7687:7687
    environment:
    - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-password}
    - NEO4J_PLUGINS=["apoc"]
    volumes:
    - neo4j_data:/data
    networks:
    - ushadow-network
    - infra-network
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - wget
      - --no-verbose
      - --tries=1
      - --spider
      - http://localhost:7474
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: keycloak
    profiles:
    - infra
    - keycloak
    depends_on:
      postgres:
        condition: service_healthy
    ports:
    - ${KEYCLOAK_PORT:-8081}:8080
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER:-ushadow}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-ushadow}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HOSTNAME_PORT: ${KEYCLOAK_PORT:-8081}
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_FEATURES: authorization,token-exchange,admin-fine-grained-authz
    volumes:
    - ../config/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    - ../config/keycloak/themes:/opt/keycloak/themes:ro
    command:
    - start-dev
    - --import-realm
    networks:
    - infra-network
    - ushadow-network
    restart: unless-stopped
    healthcheck:
      test:
      - CMD-SHELL
      - 'exec 3<>/dev/tcp/localhost/8080 && echo -e ''GET /health/ready HTTP/1.1\r\nHost:
        localhost\r\n\r\n'' >&3 && cat <&3 | grep -q ''200 OK'''
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
networks:
  infra-network:
    name: infra-network
    external: true
  ushadow-network:
    name: ushadow-network
    external: true
volumes:
  mongo_data:
    driver: local
  redis_data:
    driver: local
  qdrant_data:
    driver: local
  postgres_data:
    driver: local
  neo4j_data:
    driver: local
  keycloak_data:
    driver: local
  tailscale_state:
    driver: local
