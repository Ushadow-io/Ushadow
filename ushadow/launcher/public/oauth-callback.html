<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Completing Login...</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #0a0a0a;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-center;
      min-height: 100vh;
    }
    .container {
      text-align: center;
      max-width: 500px;
      padding: 40px;
    }
    .spinner {
      border: 3px solid rgba(59, 130, 246, 0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .success {
      color: #10b981;
      font-size: 24px;
      margin-bottom: 12px;
    }
    .error {
      color: #ef4444;
      font-size: 18px;
      margin-bottom: 12px;
    }
    .message {
      color: #9ca3af;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner" id="spinner"></div>
    <div id="status">Completing authentication...</div>
    <div class="message" id="message">Please wait while we process your login</div>
  </div>

  <script>
    (async function() {
      const statusEl = document.getElementById('status')
      const messageEl = document.getElementById('message')
      const spinnerEl = document.getElementById('spinner')

      try {
        // Extract code and state from URL
        const params = new URLSearchParams(window.location.search)
        const code = params.get('code')
        const state = params.get('state')
        const error = params.get('error')
        const errorDescription = params.get('error_description')

        // Check for OAuth errors
        if (error) {
          throw new Error(errorDescription || error)
        }

        if (!code) {
          throw new Error('Missing authorization code')
        }

        if (!state) {
          throw new Error('Missing state parameter')
        }

        // Verify state (CSRF protection)
        const savedState = localStorage.getItem('oauth_state')
        if (state !== savedState) {
          throw new Error('Invalid state parameter')
        }

        // Get code verifier
        const codeVerifier = localStorage.getItem('pkce_code_verifier')
        if (!codeVerifier) {
          throw new Error('Missing PKCE code verifier')
        }

        // Get backend URL from localStorage (set by AuthButton before opening auth window)
        const backendUrl = localStorage.getItem('oauth_backend_url')
        if (!backendUrl) {
          throw new Error('Missing backend URL configuration')
        }

        // Exchange code for tokens via backend
        const response = await fetch(`${backendUrl}/api/auth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code,
            code_verifier: codeVerifier,
            redirect_uri: window.location.origin + window.location.pathname,
          }),
        })

        if (!response.ok) {
          const error = await response.text()
          throw new Error(`Token exchange failed: ${error}`)
        }

        const tokens = await response.json()

        // Store tokens in localStorage
        localStorage.setItem('kc_access_token', tokens.access_token)
        if (tokens.refresh_token) {
          localStorage.setItem('kc_refresh_token', tokens.refresh_token)
        }
        if (tokens.id_token) {
          localStorage.setItem('kc_id_token', tokens.id_token)
        }

        // Store expiry times
        const now = Math.floor(Date.now() / 1000)
        if (tokens.expires_in) {
          localStorage.setItem('kc_expires_at', (now + tokens.expires_in).toString())
        }
        if (tokens.refresh_expires_in) {
          localStorage.setItem('kc_refresh_expires_at', (now + tokens.refresh_expires_in).toString())
        }

        // Clean up
        localStorage.removeItem('oauth_state')
        localStorage.removeItem('pkce_code_verifier')
        localStorage.removeItem('oauth_backend_url')

        // Show success message
        spinnerEl.style.display = 'none'
        statusEl.className = 'success'
        statusEl.textContent = 'âœ“ Authentication Successful!'
        messageEl.textContent = 'You can close this window and return to the launcher'

        // Close window after 2 seconds
        setTimeout(() => {
          window.close()
        }, 2000)
      } catch (error) {
        console.error('OAuth callback error:', error)
        spinnerEl.style.display = 'none'
        statusEl.className = 'error'
        statusEl.textContent = 'Authentication Failed'
        messageEl.textContent = error.message || 'An error occurred during login'
      }
    })()
  </script>
</body>
</html>
