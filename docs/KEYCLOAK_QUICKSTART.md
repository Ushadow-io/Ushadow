# Keycloak Quick Start (Model A: Guest Accounts)

This guide gets Keycloak running on your ushadow instance in ~10 minutes.

## What You're Building

**Model A Architecture**: Each ushadow instance runs its own Keycloak
- Your users login via YOUR Keycloak (local to your instance)
- When you share voice messages, recipients create guest accounts
- Social login (Google/GitHub) makes it seamless - no passwords

## Step 1: Start Infrastructure (2 min)

```bash
# Start Postgres (Keycloak needs it)
docker compose -f compose/docker-compose.infra.yml --profile postgres up -d

# Verify Postgres is healthy
docker compose -f compose/docker-compose.infra.yml ps
```

Expected output:
```
NAME       STATUS    HEALTH
postgres   Up        healthy
```

## Step 2: Add Keycloak Secrets (1 min)

Add to `config/SECRETS/secrets.yaml`:

```yaml
keycloak:
  admin_password: "changeme-secure-password"  # CHANGE THIS!
  backend_client_secret: null  # Will be generated by setup script
```

## Step 3: Start Keycloak (2 min)

```bash
# Start Keycloak
docker compose -f compose/keycloak.yml --profile keycloak up -d

# Watch it start (takes ~60 seconds)
docker logs -f ushadow-keycloak
```

Wait for:
```
INFO  [org.keycloak.services] (main) KC-SERVICES0050: Initializing master realm
INFO  [org.keycloak.services] (main) KC-SERVICES0009: Added user 'admin' to realm 'master'
```

Press Ctrl+C when you see those messages.

## Step 4: Verify Keycloak is Running (1 min)

```bash
# Check health
curl http://localhost:8080/health/ready

# Expected output:
{"status":"UP","checks":[]}
```

Open http://localhost:8080 in your browser:
- Username: `admin`
- Password: (what you set in secrets.yaml)

You should see the Keycloak admin console!

## Step 5: Run Setup Script (3 min)

The setup script creates:
- `ushadow` realm (your authentication domain)
- Backend client (for API authentication)
- Frontend client (for web UI login)
- Example users (optional, for testing)

```bash
# Install Python dependencies
pip install python-keycloak python-dotenv

# Run setup
python scripts/setup_keycloak.py
```

Expected output:
```
ğŸ”§ Connecting to Keycloak at http://localhost:8080...
âœ… Connected successfully

ğŸ“¦ Creating realm 'ushadow'...
âœ… Realm created

ğŸ” Creating backend client...
âœ… Backend client created
   Client secret: abc123xyz...
   âš ï¸  Save this to config/SECRETS/secrets.yaml: KEYCLOAK_BACKEND_SECRET=abc123xyz

ğŸŒ Creating frontend client...
âœ… Frontend client created

âœ… Keycloak setup complete!
```

## Step 6: Save Client Secret (1 min)

Copy the backend client secret from the output and add to `config/SECRETS/secrets.yaml`:

```yaml
keycloak:
  admin_password: "your-secure-password"
  backend_client_secret: "abc123xyz..."  # Paste the secret here
```

## Step 7: Test Login (2 min)

Open Keycloak admin console: http://localhost:8080

Navigate to:
1. **Realms** (top left) â†’ Select `ushadow`
2. **Clients** â†’ Click `ushadow-frontend`
3. **Settings** â†’ Scroll down to see configuration

You should see:
- Client ID: `ushadow-frontend`
- Access Type: `public`
- Valid Redirect URIs: `http://localhost:*/*`

This means frontend login will work!

## What's Next?

Now you're ready to integrate Keycloak into your backend:

1. **Enable Keycloak** in `config/config.defaults.yaml`:
   ```yaml
   keycloak:
     enabled: true  # Change from false to true
   ```

2. **Follow the migration guide**: `docs/KEYCLOAK_MIGRATION.md`

## Quick Reference

| Task | Command |
|------|---------|
| Start Keycloak | `docker compose -f compose/keycloak.yml --profile keycloak up -d` |
| Stop Keycloak | `docker compose -f compose/keycloak.yml down` |
| View logs | `docker logs -f ushadow-keycloak` |
| Restart Keycloak | `docker compose -f compose/keycloak.yml restart keycloak` |
| Admin console | http://localhost:8080 |
| Reset setup | See "Troubleshooting" below |

## Troubleshooting

### Keycloak won't start

```bash
# Check if port 8080 is already in use
lsof -i :8080

# If something else is using it, change KEYCLOAK_PORT in .env
echo "KEYCLOAK_PORT=8081" >> .env
```

### Forgot admin password

```bash
# Reset admin password
docker compose -f compose/keycloak.yml down
# Change password in config/SECRETS/secrets.yaml
docker compose -f compose/keycloak.yml up -d
```

### Want to start fresh

```bash
# Stop Keycloak
docker compose -f compose/keycloak.yml down

# Remove Keycloak data (CAREFUL: deletes all users!)
docker exec postgres psql -U ushadow -c "DROP DATABASE keycloak;"
docker exec postgres psql -U ushadow -c "CREATE DATABASE keycloak;"

# Start again
docker compose -f compose/keycloak.yml up -d
python scripts/setup_keycloak.py
```

## Architecture Reminder

```
Your Ushadow Instance
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Keycloak (Docker)      â”‚ â† Runs locally on YOUR server
â”‚  - Your users          â”‚
â”‚  - Guest accounts      â”‚
â”‚  - Social login setup  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ushadow Backend        â”‚
â”‚  - Validates tokens    â”‚
â”‚  - Manages permissions â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

When you share a voice message:
1. Recipient clicks link â†’ comes to YOUR server
2. Sees "Login with Google" â†’ YOUR Keycloak handles it
3. Creates guest account â†’ stored in YOUR database
4. Downloads file â†’ served by YOUR backend

**No central server. Fully self-hosted. âœ…**
