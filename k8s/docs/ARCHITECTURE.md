# K8s Directory File Inventory

**Purpose:** Understand what each file does and whether it's needed.

## Quick Legend

| Symbol | Meaning |
|--------|---------|
| âœ… **KEEP** | Actively used, commit to git |
| ğŸ¤– **GENERATED** | Auto-generated, add to .gitignore |
| ğŸ”§ **OPTIONAL** | Use for specific scenarios |
| â“ **REVIEW** | May be old/duplicate, check if needed |
| ğŸ“š **DOCS** | Documentation, commit to git |

---

## Deployment Methods Overview

**You have 3 ways to deploy ushadow to K8s:**

1. **Skaffold** (NEW - recommended for development)
   - Uses: `skaffold.yaml`, `base/*.yaml`, `infra/*.yaml`
   - Auto-builds, deploys, watches for changes
   - See: `README-SKAFFOLD.md`

2. **Kustomize** (Manual K8s deployment)
   - Uses: `kustomization.yaml`, `base/*.yaml`, `infra/*.yaml`
   - Command: `kubectl apply -k k8s/`
   - Good for: GitOps, production

3. **Ushadow Compose-to-K8s** (OLD - via ushadow backend API)
   - Generates: `compose-configmap.yaml` (auto-generated)
   - Converts Docker Compose â†’ K8s manifests dynamically
   - See: `COMPOSE-CONFIGMAP-AUTOMATED.md`

**Most files support multiple methods!**

---

## File Categories

### ğŸ¯ Core Application Manifests (KEEP - Skaffold/Kustomize)

| File | Used By | Purpose | Status |
|------|---------|---------|--------|
| `ushadow-namespace.yaml` | Skaffold, Kustomize | Creates `ushadow` namespace | âœ… KEEP |
| `base/backend-deployment.yaml` | Skaffold, Kustomize | Ushadow backend deployment | âœ… KEEP |
| `base/backend-service.yaml` | Skaffold, Kustomize | Backend ClusterIP service | âœ… KEEP |
| `base/backend-pvc.yaml` | Skaffold, Kustomize | Persistent storage for kubeconfigs | âœ… KEEP |
| `base/backend-secrets.yaml.example` | Documentation | Template for creating secrets | âœ… KEEP |
| `base/webui-deployment.yaml` | Kustomize (optional) | Frontend deployment | ğŸ”§ OPTIONAL |
| `base/webui-service.yaml` | Kustomize (optional) | Frontend service | ğŸ”§ OPTIONAL |

**Notes:**
- Backend manifests **mount config-files ConfigMap at /config/** - this is critical!
- Secrets created via `create-secrets.sh` script (not checked into git)
- Frontend currently disabled in Skaffold (backend-only for now)

---

### ğŸ—ï¸ Infrastructure Manifests (KEEP - Skaffold/Kustomize)

| File | Purpose | Status |
|------|---------|--------|
| `infra/mongo-deployment.yaml` | MongoDB StatefulSet | âœ… KEEP |
| `infra/mongo-service.yaml` | MongoDB Service | âœ… KEEP |
| `infra/redis-deployment.yaml` | Redis Deployment | âœ… KEEP |
| `infra/redis-service.yaml` | Redis Service | âœ… KEEP |
| `infra/qdrant-deployment.yaml` | Qdrant vector DB | âœ… KEEP |
| `infra/qdrant-service.yaml` | Qdrant Service | âœ… KEEP |
| `infra/postgresql-deployment.yaml` | PostgreSQL (for Keycloak) | âœ… KEEP |
| `infra/postgres-service.yaml` | PostgreSQL Service | â“ REVIEW (duplicate?) |
| `infra/postgres-deployment.yaml` | PostgreSQL (alternative) | â“ REVIEW (duplicate?) |
| `infra/keycloak-deployment.yaml` | Keycloak SSO | âœ… KEEP |
| `infra/keycloak-values.yaml` | Keycloak Helm values | ğŸ”§ OPTIONAL (Helm) |

**Notes:**
- **Duplicate PostgreSQL files exist!** `postgres-deployment.yaml` vs `postgresql-deployment.yaml`
  - `postgresql-deployment.yaml` = StatefulSet (newer, more features)
  - `postgres-deployment.yaml` = Simple Deployment
  - **Recommendation:** Delete `postgres-deployment.yaml` and `postgres-service.yaml`

---

### ğŸ¤– Auto-Generated Files (ADD TO .GITIGNORE)

| File | Generated By | Size | Status |
|------|--------------|------|--------|
| `compose-configmap.yaml` | Ushadow backend API | 2665 lines | ğŸ¤– **GITIGNORE** |

**Why gitignore?**
- Auto-regenerated on every deployment
- Contains parsed Docker Compose files
- Changes cause merge conflicts
- See `COMPOSE-CONFIGMAP-AUTOMATED.md` for details

---

### ğŸ› ï¸ Utility Scripts (KEEP - Deployment Helpers)

#### Secret/ConfigMap Creation
| File | Purpose | When to Use |
|------|---------|-------------|
| `create-secrets.sh` | Create backend secrets from .env | Every deployment |
| `create-infra-secrets.sh` | Create PostgreSQL/Keycloak secrets | Initial setup |
| `create-config-configmap.sh` | Create config files ConfigMap | Every deployment |
| `scripts/generate-compose-configmap.sh` | Generate compose ConfigMap manually | Debugging compose-to-k8s |

#### DNS Configuration
| File | Purpose | When to Use |
|------|---------|-------------|
| `add-ushadow-dns.sh` | Add ushadow to CoreDNS | When using Tailscale DNS |
| `add-keycloak-dns.sh` | Add Keycloak to CoreDNS | When using Tailscale DNS |
| `setup-ushadow-dns.sh` | Full DNS setup | Initial Tailscale DNS config |
| `test-ushadow-dns.sh` | Test DNS resolution | Verify DNS working |
| `create-ushadow-ingress.sh` | Create Ingress resources | When using nginx-ingress |

#### Infrastructure Helpers
| File | Purpose | When to Use |
|------|---------|-------------|
| `infra/setup-keycloak.sh` | Setup Keycloak with PostgreSQL | Initial Keycloak setup |
| `infra/setup-dockerhub-auth.sh` | Create Docker Hub pull secrets | Air-gapped/rate limits |
| `infra/setup-registry-mirror.sh` | Setup local registry mirror | Air-gapped clusters |
| `infra/pull-and-push-images.sh` | Mirror images to local registry | Air-gapped deployment |
| `infra/update-deployments-to-local-registry.sh` | Update image refs to local registry | Air-gapped deployment |
| `infra/clear-image-cache.sh` | Clear containerd image cache | Free up disk space |

---

### ğŸŒ Network/Ingress Manifests (OPTIONAL)

| File | Purpose | Status |
|------|---------|--------|
| `ushadow-ingress.yaml` | Nginx Ingress for ushadow | ğŸ”§ OPTIONAL |
| `keycloak-ingress.yaml` | Nginx Ingress for Keycloak | ğŸ”§ OPTIONAL |
| `tweaks/ingress-example.yaml` | Example Ingress manifest | ğŸ“š DOCS |
| `gai-conf-fix.yaml` | Network config fix (getaddrinfo) | ğŸ”§ OPTIONAL |

**Notes:**
- Only needed if using Ingress Controller
- Contains instance-specific domains (`*.chakra`)
- Skaffold uses port-forwarding instead

---

### ğŸ“‹ Configuration Files

| File | Purpose | Status |
|------|---------|--------|
| `kustomization.yaml` | Kustomize overlay definition | âœ… KEEP (if using Kustomize) |
| `.gitignore` | Git ignore rules | âœ… KEEP |

---

### ğŸ“š Documentation (KEEP)

| File | Content |
|------|---------|
| `README-SKAFFOLD.md` | Skaffold development guide |
| `CLEANUP-SUMMARY.md` | Recent cleanup changes |
| `COMPOSE-CONFIGMAP-AUTOMATED.md` | Compose-to-K8s system docs |
| `COMPOSE-CONFIGMAP-README.md` | ConfigMap usage guide |
| `USHADOW_DNS_SETUP.md` | Tailscale DNS setup |
| `FILE-INVENTORY.md` | This file |
| `tweaks/README.md` | Kompose conversion notes |
| `tweaks/mongo-statefulset-example.yaml` | StatefulSet example |

---

## What Do I Actually Need?

### Minimal Skaffold Deployment

**Required files:**
```
k8s/
â”œâ”€â”€ ushadow-namespace.yaml          # Namespace
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ backend-deployment.yaml     # Backend (with ConfigMap mount!)
â”‚   â”œâ”€â”€ backend-service.yaml        # Backend service
â”‚   â””â”€â”€ backend-pvc.yaml            # Persistent storage
â”œâ”€â”€ infra/
â”‚   â”œâ”€â”€ mongo-deployment.yaml       # Database
â”‚   â”œâ”€â”€ mongo-service.yaml
â”‚   â”œâ”€â”€ redis-deployment.yaml       # Cache
â”‚   â””â”€â”€ redis-service.yaml
â”œâ”€â”€ create-secrets.sh               # Create secrets
â””â”€â”€ create-config-configmap.sh      # Create config files

skaffold.yaml                        # At project root
```

**Run with:**
```bash
./k8s/create-secrets.sh
skaffold run -p application
```

### Full Infrastructure Deployment

**Add these:**
```
infra/
â”œâ”€â”€ postgresql-deployment.yaml      # For Keycloak
â”œâ”€â”€ keycloak-deployment.yaml        # SSO
â””â”€â”€ qdrant-deployment.yaml          # Vector DB (if using)

create-infra-secrets.sh             # PostgreSQL/Keycloak passwords
```

---

## Cleanup Recommendations

### ğŸ—‘ï¸ Safe to Delete (Duplicates/Old)

```bash
# Duplicate PostgreSQL (older, simpler version)
rm k8s/infra/postgres-deployment.yaml
rm k8s/infra/postgres-service.yaml

# Old Keycloak values (if not using Helm)
rm k8s/infra/keycloak-values.yaml  # Only if you're not using Helm
```

### â“ Review These (Depends on Your Setup)

**If NOT using Tailscale DNS:**
- Delete: `add-ushadow-dns.sh`, `add-keycloak-dns.sh`, `setup-ushadow-dns.sh`, `test-ushadow-dns.sh`
- Delete: `USHADOW_DNS_SETUP.md`

**If NOT using Ingress:**
- Delete: `ushadow-ingress.yaml`, `keycloak-ingress.yaml`, `create-ushadow-ingress.sh`

**If NOT air-gapped (have internet):**
- Delete: `infra/setup-registry-mirror.sh`, `infra/pull-and-push-images.sh`, `infra/update-deployments-to-local-registry.sh`

**If NOT using Kustomize:**
- Delete: `kustomization.yaml`, `tweaks/`

**If using Skaffold exclusively:**
- Keep `kustomization.yaml` commented out in Skaffold
- Or integrate Kustomize into Skaffold deploy section

---

## Decision Matrix

| Deployment Method | Files Needed | Files to Ignore |
|-------------------|--------------|-----------------|
| **Skaffold Dev** | base/, infra/, create-*.sh, skaffold.yaml | compose-configmap.yaml, kustomization.yaml |
| **Kustomize** | base/, infra/, kustomization.yaml, create-*.sh | compose-configmap.yaml, skaffold.yaml |
| **Compose-to-K8s** | compose/ directory, ushadow backend | Everything in k8s/ (backend generates manifests) |
| **Hybrid** | All of the above | compose-configmap.yaml (still generated) |

---

## File Size Breakdown

```
Large files (generated):
  compose-configmap.yaml     2665 lines  ğŸ¤– GITIGNORE

Active manifests:
  base/*.yaml                ~200 lines  âœ… KEEP
  infra/*.yaml              ~500 lines  âœ… KEEP

Scripts:
  *.sh                       ~100 lines each  âœ… KEEP

Docs:
  *.md                       ~500 lines total  ğŸ“š KEEP
```

---

## Summary

**KEEP (commit to git):** 25 files
- Core manifests (base/, infra/)
- Utility scripts (create-*.sh, add-*.sh)
- Documentation (*.md)
- Namespace definition
- .gitignore

**GITIGNORE (generated):** 1 file
- compose-configmap.yaml

**DELETE (duplicates):** 2-3 files
- postgres-deployment.yaml (use postgresql-deployment.yaml)
- postgres-service.yaml
- keycloak-values.yaml (if not using Helm)

**OPTIONAL (depends on setup):** 10+ files
- DNS scripts (if using Tailscale DNS)
- Ingress manifests (if using Ingress)
- Air-gap scripts (if offline)
- Kustomization (if not using Kustomize)

**Current state:** Ready for Skaffold deployment with ConfigMap mounts! ğŸ‰
