# K8s Directory Cleanup Summary

Date: 2026-02-15

## Changes Made

### 1. Deleted Files

**Old/Duplicate Files Removed:**
- ‚úÖ `namespace.yaml` - Duplicate of `ushadow-namespace.yaml` with instance-specific `env: purple` label
- ‚úÖ `configmap.yaml` - Hardcoded `ENV_NAME: "purple"`, should be generated dynamically
- ‚úÖ `secret.yaml` - Unused template, replaced by `create-secrets.sh` scripts

### 2. Security Fixes

**CRITICAL: Removed Hardcoded Passwords**

**Before:**
```yaml
# postgresql-deployment.yaml
- name: POSTGRES_PASSWORD
  value: "MED$4pstnnut"  # HARDCODED!

# keycloak-deployment.yaml
- name: KEYCLOAK_ADMIN_PASSWORD
  value: "changeme123"  # HARDCODED!
```

**After:**
```yaml
# postgresql-deployment.yaml
- name: POSTGRES_PASSWORD
  valueFrom:
    secretKeyRef:
      name: postgres-credentials
      key: password

# keycloak-deployment.yaml
- name: KEYCLOAK_ADMIN_PASSWORD
  valueFrom:
    secretKeyRef:
      name: keycloak-admin-secret
      key: password
```

**Action Required:**
```bash
# Create secrets with your passwords
./k8s/create-infra-secrets.sh
```

### 3. Removed Hardcoded Registry References

**Before:**
```yaml
image: anubis:32000/postgresql:17
image: anubis:32000/keycloak:26.0
```

**After:**
```yaml
image: ${K8S_REGISTRY:-docker.io}/postgres:17
image: ${K8S_REGISTRY:-quay.io}/keycloak/keycloak:26.0
```

### 4. Made DNS Scripts Generic

**Updated Scripts:**
- ‚úÖ `add-ushadow-dns.sh` - Now auto-detects Ingress IP and uses `DNS_DOMAIN` env var
- ‚úÖ `add-keycloak-dns.sh` - Now auto-detects Ingress IP and uses `DNS_DOMAIN` env var

**Before:**
```bash
DOMAIN="chakra"           # Hardcoded
INGRESS_IP="10.152.183.53"  # Hardcoded
```

**After:**
```bash
DOMAIN="${DNS_DOMAIN:-chakra}"              # Configurable via env var
INGRESS_IP=$(kubectl get svc ... )          # Auto-detected
```

**Usage:**
```bash
# Use defaults (chakra domain, auto-detect IP)
./k8s/add-ushadow-dns.sh

# Override domain
DNS_DOMAIN=mycompany ./k8s/add-ushadow-dns.sh

# Override everything
DNS_DOMAIN=mycompany INGRESS_IP=10.0.0.1 ./k8s/add-ushadow-dns.sh
```

### 5. Updated kustomization.yaml

**Removed:**
- References to deleted files (`namespace.yaml`, `configmap.yaml`, `secret.yaml`)
- Reference to auto-generated `compose-configmap.yaml`
- Instance-specific label `env: purple`

**Before:**
```yaml
resources:
  - namespace.yaml
  - configmap.yaml
  - secret.yaml
  - compose-configmap.yaml

commonLabels:
  env: purple
```

**After:**
```yaml
resources:
  - ushadow-namespace.yaml
  # compose-configmap.yaml is auto-generated
  # secrets/configmaps created via scripts

commonLabels:
  app: ushadow
  # env: <set via overlay or kustomize edit>
```

### 6. Created .gitignore

**Added:**
```gitignore
# Auto-generated by ushadow backend
compose-configmap.yaml

# Instance-specific configurations
configmap.yaml
namespace.yaml
secret.yaml

# Environment-specific overrides
*-local.yaml

# Actual secrets (examples are OK)
base/backend-secrets.yaml
```

### 7. New Utility Scripts

**Created:**
- ‚úÖ `create-config-configmap.sh` - Create backend config files ConfigMap
- ‚úÖ `create-secrets.sh` - Create ushadow backend secrets from .env
- ‚úÖ `create-infra-secrets.sh` - Create PostgreSQL and Keycloak secrets

## What's Generic Now (Safe to Commit)

‚úÖ **Application Manifests** (`base/`)
- backend-deployment.yaml
- backend-service.yaml
- backend-pvc.yaml
- backend-secrets.yaml.example (template)
- webui-deployment.yaml
- webui-service.yaml

‚úÖ **Infrastructure Manifests** (`infra/`)
- All deployment and service files (now use secrets)
- Setup scripts (dockerhub-auth, keycloak, registry-mirror)

‚úÖ **Utility Scripts**
- create-config-configmap.sh
- create-secrets.sh
- create-infra-secrets.sh
- add-ushadow-dns.sh (now parameterized)
- add-keycloak-dns.sh (now parameterized)

‚úÖ **Documentation**
- COMPOSE-CONFIGMAP-AUTOMATED.md
- COMPOSE-CONFIGMAP-README.md
- README-SKAFFOLD.md
- USHADOW_DNS_SETUP.md

## What's Gitignored (Instance-Specific)

üö´ **Auto-generated:**
- compose-configmap.yaml (2665 lines, generated by backend)

üö´ **Instance-specific:**
- Any files with your cluster IPs, domains, or passwords
- *-local.yaml override files

## Environment Variables Reference

For different environments, set these before running scripts:

```bash
# DNS configuration
export DNS_DOMAIN="chakra"              # Your domain
export INGRESS_IP="10.152.183.53"       # Or leave empty to auto-detect

# Registry (for air-gapped/offline)
export K8S_REGISTRY="registry.local:5000"

# Database credentials
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD="secure-password"
export KEYCLOAK_ADMIN="admin"
export KEYCLOAK_ADMIN_PASSWORD="secure-password"
export MONGODB_USER="root"
export MONGODB_PASSWORD="secure-password"

# Backend auth
export AUTH_SECRET_KEY="random-secret-key"
```

## Deployment Checklist

1. **Set environment variables** (or update .env file)
2. **Create secrets:**
   ```bash
   ./k8s/create-secrets.sh           # Ushadow backend secrets
   ./k8s/create-infra-secrets.sh     # PostgreSQL, Keycloak
   ```

3. **Create ConfigMaps:**
   ```bash
   ./k8s/create-config-configmap.sh  # Backend config files
   ```

4. **Deploy with Skaffold:**
   ```bash
   skaffold run -p infrastructure    # Infrastructure layer
   skaffold run -p application        # Application layer
   ```

5. **Configure DNS (optional):**
   ```bash
   DNS_DOMAIN=mycompany ./k8s/add-ushadow-dns.sh
   ```

## Validation

**Check that cleanup worked:**
```bash
# No hardcoded passwords
grep -r "value:.*password" k8s/infra/ && echo "FAIL: Found hardcoded password!" || echo "PASS"

# No instance-specific labels
grep -r "env: purple" k8s/ && echo "FAIL: Found instance-specific label!" || echo "PASS"

# No hardcoded IPs (except in docs)
grep -r "10.152.183" k8s/*.sh && echo "Check: Found hardcoded IP in script"

# .gitignore works
git status k8s/ | grep compose-configmap.yaml && echo "FAIL: Should be ignored!" || echo "PASS"
```

## Next Steps

- ‚úÖ Cleanup complete
- ‚úÖ Security issues fixed
- ‚úÖ Scripts parameterized
- ‚úÖ Gitignore configured
- ‚è≠Ô∏è Ready to add Skaffold configuration
- ‚è≠Ô∏è Ready to test ConfigMap mounting with Skaffold
